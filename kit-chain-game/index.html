<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Flatchat Games - Kit Chain</title>
  <link rel="icon" type="image/x-icon" href="../icons/flatchat-small.webp">
  <link rel="preconnect" href="https://www.youtube.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<script src="data.js"></script>

<style>
:root{
  --brand:#179aa3;
  --shirt:#034694;
  --wrong:#d62828;
  --complete:#2a9d4b;
  --bg:#f4fbfc;
}

*{ box-sizing:border-box; }

body{
  margin:0;
  font-family:'Inter',sans-serif;
  background:var(--bg);
  text-align:center;
}

.game-container{
  display:flex;
  justify-content:center;
  min-height:auto;
}

.card{
  width:min(95vw,900px);
  margin:20px auto;
  padding:25px;
  background:white;
  border-radius:22px;
  box-shadow:0 15px 40px rgba(0,0,0,0.06);
  position:relative;
}

.card:-webkit-full-screen{
  width:100vw;
  height:100vh;
  border-radius:0;
  margin:0;
}

.card:not(:fullscreen):not(:-webkit-full-screen){
  height:auto !important;
}

.meta{
  font-weight:700;
  margin-bottom:10px;
}

.difficulty-badge{
  display:inline-block;
  padding:6px 14px;
  border-radius:20px;
  font-size:0.8rem;
  font-weight:700;
  margin-bottom:10px;
  text-transform:uppercase;
}

.easy{ background:#d1fae5; color:#065f46; }
.medium{ background:#fef3c7; color:#92400e; }
.hard{ background:#fee2e2; color:#991b1b; }

.section{ margin-top:20px; }

.search-wrapper{
  width:100%;
  max-width:420px;
  margin:10px auto;
  position:relative;
}

.search{
  width:100%;
  padding:10px;
  border-radius:12px;
  border:2px solid var(--brand);
  font-size:16px;
}

.dropdown{
  position:absolute;
  width:100%;
  background:white;
  border:2px solid var(--brand);
  border-radius:14px;
  max-height:160px;
  overflow-y:auto;
  z-index:10;
}

.dropdown-item{
  padding:10px;
  cursor:pointer;
  font-weight:600;
}

.dropdown-item:hover{ background:#eefbfc; }

#play-area{
  transition: zoom 0.25s ease;
}

.kit-stage{
  display:flex;
  flex-direction:column;   /* IMPORTANT */
  align-items:center;
  gap:14px;
  margin-top:3vh;
}

.kit-card{
  width:min(90vw,650px);
  aspect-ratio:4/3;
  background:var(--shirt);
  border-radius:28px;
  padding:30px;
  position:relative;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:space-between;
  transition:transform 0.25s ease;
  transform-origin:center top;
}

.badge{
  position:absolute;
  top:24px;
  left:24px;
  width:70px;
}

.badge img{ width:100%; }

.kit-name-arc{
  width:100%;
  height:120px;   /* more vertical room */
  margin-top:10px;
  overflow:visible;  /* prevent clipping */
}

.kit-name-arc svg{
  width:100%;
  height:100%;
}

.kit-name-arc text{
  fill:white;
  font-weight:800;
}

.kit-number{
  font-size:clamp(60px,10vw,140px);
  color:white;
  line-height:1;
}

.sponsor{
  width:55%;
  height:60px;
  display:flex;
  align-items:center;
  justify-content:center;
}

.sponsor img{
  max-width:200px;
  max-height:200px;
  object-fit:contain;
}

/* COMPLETED */

.completed-strip{
  width:300px;
  background:#eef7f0;
  border-left:6px solid var(--complete);
  padding:10px 14px;
  border-radius:12px;
  font-weight:600;
}

.completed-row{
  background:#eef7f0;
  border-left:6px solid var(--complete);
  padding:10px 14px;
  border-radius:12px;
  font-weight:600;
  display:inline-flex;              /* inline */
  align-items:center;
  gap:8px;
  white-space:nowrap;
}

.completed-container{
  display:flex;
  flex-wrap:wrap;
  justify-content:center;
  gap:12px;
  max-width:900px;
}

button{
  margin-top:20px;
  padding:12px 24px;
  background:var(--brand);
  color:white;
  border:none;
  border-radius:16px;
  font-weight:700;
  cursor:pointer;
}

/* FULLSCREEN */

.fullscreen-btn{
  position:absolute;
  top:15px;
  right:15px;
  background:white;
  border:2px solid var(--brand);
  border-radius:10px;
  padding:6px 10px;
  font-weight:700;
  cursor:pointer;
}

.card:fullscreen{
  width:100vw;
  height:100vh;
  border-radius:0;
  margin:0;
}
</style>
</head>

<body>
<div data-include="../includes/header.html"></div>

<div class="game-container">
<div class="card">

<button id="fullscreenBtn" class="fullscreen-btn">Fullscreen ‚õ∂</button>

<div class="meta">
Lives: <span id="lives"></span> |
Score: <span id="score"></span>
</div>

<div id="difficultyBadge"></div>

<div id="play-area">

  <div id="after-section" class="section">

  <h3>Who wore it after?</h3>

  <div class="search-wrapper">
    <input 
      type="text" 
      id="search-later" 
      class="search" 
      autocomplete="off"
    >
    <div id="dropdown-later" class="dropdown"></div>
  </div>

</div>

  <div class="kit-stage" id="kit-stage"></div>

  <div id="before-section" class="section">

  <h3>Who wore it before?</h3>

  <div class="search-wrapper">
    <input 
      type="text" 
      id="search-earlier" 
      class="search" 
      autocomplete="off"
    >
    <div id="dropdown-earlier" class="dropdown"></div>
  </div>

  <div id="message"></div>
  <button onclick="startRound()">New Round</button>

</div>

</div>

</div>
</div>

<div data-include="../includes/footer.html"></div>
<script src="../includes/include-html.js"></script>

<script>

/* === YOUR ORIGINAL FULL GAME LOGIC RESTORED === */

let currentRound;
let foundRange;
let lives;
let score;
let gameState;

function startRound(){

  const allRounds=[];
  GAME_DATA.forEach(club=>{
    club.kitNumbers.forEach(kit=>{
      allRounds.push({
        club:club.club,
        badge:club.badge,
        shirtNumber:kit.number,
        difficulty:kit.difficulty,
        players:kit.players,
        primaryColor:club.primaryColor
      });
    });
  });

  currentRound=allRounds[Math.floor(Math.random()*allRounds.length)];

  document.documentElement.style.setProperty("--brand",currentRound.primaryColor);
  document.documentElement.style.setProperty("--shirt",currentRound.primaryColor);

  lives=3;
  score=0;
  gameState="playing";

  const startIndex=Math.floor(Math.random()*currentRound.players.length);
  foundRange=[startIndex,startIndex];

  render();
}

function formatKitName(fullName){
  const parts=fullName.trim().split(" ");
  const prefixes=["de","da","di","van","von","del","la","le"];
  if(parts.length>1){
    const secondLast=parts[parts.length-2].toLowerCase();
    if(prefixes.includes(secondLast)){
      return (parts[parts.length-2]+" "+parts[parts.length-1]).toUpperCase();
    }
  }
  return parts[parts.length-1].toUpperCase();
}

function getAllPlayers(){
  const all=[];
  GAME_DATA.forEach(club=>{
    club.kitNumbers.forEach(kit=>{
      kit.players.forEach(p=>all.push(p.name));
    });
  });
  return [...new Set(all)];
}

function render(){

  document.getElementById("lives").textContent = lives;
  document.getElementById("score").textContent = score;

  const badge = document.getElementById("difficultyBadge");
  badge.innerHTML = `
    <span class="difficulty-badge ${currentRound.difficulty}">
      ${currentRound.club} No.${currentRound.shirtNumber} ‚Äì ${currentRound.difficulty}
    </span>
  `;

  const stage = document.getElementById("kit-stage");
  stage.innerHTML = "";

  const completedContainer = document.createElement("div");
  completedContainer.className = "completed-container";

  if(gameState === "won"){ renderCompleted(); return; }
  if(gameState === "lost"){ renderFailed(); return; }

  function renderCard(index){
    const player = currentRound.players[index];
    const lastName = formatKitName(player.name);

    const card = document.createElement("div");
    card.className = "kit-card";

// Adjust arc height based on length
let curveHeight = 35;

if (lastName.length <= 5) curveHeight = 45;
if (lastName.length >= 8) curveHeight = 30;
if (lastName.length >= 10) curveHeight = 25;
if (lastName.length >= 12) curveHeight = 20;

card.innerHTML = `
  <div class="badge"><img src="${currentRound.badge}"></div>

  <div class="kit-name-arc">
    <svg viewBox="0 0 340 180">
      <defs>
        <path id="curve${index}" d="M20,140 Q170,${curveHeight} 320,140" />
      </defs>

      <text
        text-anchor="middle"
        font-size="34"
        font-weight="800"
        fill="white"
      >
        <textPath href="#curve${index}" startOffset="50%">
          ${lastName}
        </textPath>
      </text>

    </svg>
  </div>

  <div class="kit-number">${currentRound.shirtNumber}</div>
  <div class="sponsor">
    <img src="${player.sponsor}">
  </div>
`;

    stage.appendChild(card);
  }

  function renderCompleteStrip(index){
    const player = currentRound.players[index];
    const strip = document.createElement("div");
    strip.className = "completed-row";
    strip.innerHTML = `
      <span>‚úì ${player.name}</span>
      <span>${player.years}</span>
    `;
    completedContainer.appendChild(strip);
  }

/* =========================
   RENDER DISCOVERED WINDOW
   ========================= */

for(let i = foundRange[1]; i >= foundRange[0]; i--){

  const isLowerEdge = i === foundRange[0];
  const isUpperEdge = i === foundRange[1];

  const canGoLower = foundRange[0] > 0;
  const canGoUpper = foundRange[1] < currentRound.players.length - 1;

  // Show shirt only if it's an edge AND that direction still has players
  if(
    (isLowerEdge && canGoLower) ||
    (isUpperEdge && canGoUpper)
  ){
    renderCard(i);
  }
  else{
    renderCompleteStrip(i);
  }
}

if(completedContainer.children.length > 0){
  stage.appendChild(completedContainer);
}

  for(let i = foundRange[0] - 1; i >= 0; i--){
    // undiscovered older players ‚Üí show nothing
  }

  /* =========================
     Hide search when complete
     ========================= */
const noAfter = foundRange[1] === currentRound.players.length - 1;
const noBefore = foundRange[0] === 0;

// AFTER section
document.querySelector("#after-section h3").style.display =
  noAfter ? "none" : "block";

document.querySelector("#after-section .search-wrapper").style.display =
  noAfter ? "none" : "block";

// BEFORE section
document.querySelector("#before-section h3").style.display =
  noBefore ? "none" : "block";

document.querySelector("#before-section .search-wrapper").style.display =
  noBefore ? "none" : "block";

  document.getElementById("search-earlier").value = "";
  document.getElementById("search-later").value = "";

  requestAnimationFrame(scalePlayAreaToFit);
}

function scalePlayAreaToFit(){

  const playArea = document.getElementById("play-area");

  playArea.style.zoom = "1";

  const viewportHeight = window.innerHeight;
  const playTop = playArea.getBoundingClientRect().top;
  const availableHeight = viewportHeight - playTop - 20;

  const fullHeight = playArea.scrollHeight;

  if(fullHeight <= availableHeight){
    return;
  }

  const scale = availableHeight / fullHeight;

  playArea.style.zoom = scale;
}

function renderCompleted(){
  document.getElementById("kit-stage").innerHTML=`
    <h2>üéâ Chain Complete!</h2>
    ${[...currentRound.players].reverse().map(p=>`
      <div class="completed-row">
        <span>${p.name}</span>
        <span>${p.years}</span>
      </div>
    `).join("")}
    <button onclick="startRound()">New Round</button>
  `;
}

function renderFailed(){
  document.getElementById("kit-stage").innerHTML=`
    <h2>‚ùå Out of Lives</h2>
    ${[...currentRound.players].reverse().map(p=>`
      <div class="completed-row">
        <span>${p.name}</span>
        <span>${p.years}</span>
      </div>
    `).join("")}
    <button onclick="startRound()">New Round</button>
  `;
}

function handleGuess(direction, name){

  if(gameState !== "playing") return;

  name = name.toLowerCase();

if(direction === "before"){

  if(foundRange[0] > 0){
    const expected = currentRound.players[foundRange[0] - 1];

    if(expected && name === expected.name.toLowerCase()){
      foundRange[0]--;
      score++;
    } else {
      lives--;
    }
  }
}

if(direction === "after"){

  if(foundRange[1] < currentRound.players.length - 1){
    const expected = currentRound.players[foundRange[1] + 1];

    if(expected && name === expected.name.toLowerCase()){
      foundRange[1]++;
      score++;
    } else {
      lives--;
    }
  }
}

  if(lives <= 0){
    gameState = "lost";
  }

  if(
    foundRange[0] === 0 &&
    foundRange[1] === currentRound.players.length - 1
  ){
    gameState = "won";
  }

  render();
}

function setupAutocomplete(inputId,dropdownId,direction){

  const input=document.getElementById(inputId);
  const dropdown=document.getElementById(dropdownId);

  input.addEventListener("input",function(){

    const value=this.value.toLowerCase();
    dropdown.innerHTML="";
    if(!value)return;

    getAllPlayers().forEach(name=>{
      if(name.toLowerCase().includes(value)){
        const div=document.createElement("div");
        div.className="dropdown-item";
        div.textContent=name;
        div.onclick=()=>{
          input.value="";
          dropdown.innerHTML="";
          handleGuess(direction,name);
        };
        dropdown.appendChild(div);
      }
    });
  });
}

setupAutocomplete("search-earlier","dropdown-earlier","before");
setupAutocomplete("search-later","dropdown-later","after");

startRound();

/* FULLSCREEN */

const fullscreenBtn=document.getElementById("fullscreenBtn");

fullscreenBtn.addEventListener("click",()=>{
  const card=document.querySelector(".card");
  if(!document.fullscreenElement){
    card.requestFullscreen();
  }else{
    document.exitFullscreen();
  }
});

document.addEventListener("fullscreenchange", () => {

  const playArea = document.getElementById("play-area");

  // Hard reset transform first
  playArea.style.transform = "scale(1)";

  // Force browser reflow
  void playArea.offsetHeight;

  // Wait one frame AFTER layout settles
  requestAnimationFrame(() => {
    requestAnimationFrame(() => {
      scalePlayAreaToFit();
    });
  });

});
window.addEventListener("resize", () => {
  scalePlayAreaToFit();
});
</script>

</body>
</html>
