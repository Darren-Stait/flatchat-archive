<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Flatchat Six Degrees</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

<style>
:root {
  --brand: #25b6c4;
  --brand-dark: #1e9aa6;
  --bg: #f4fbfc;
  --text: #1f2937;
  --muted: #6b7280;
}

* { box-sizing: border-box; transition: all 0.2s ease; }

body {
  margin: 0;
  font-family: 'Inter', sans-serif;
  background: var(--bg);
  color: var(--text);
}

.card {
  max-width: 1000px;
  margin: 50px auto;
  padding: 40px;
  border-radius: 20px;
  background: #ffffff;
  border: 2px solid var(--brand);
  box-shadow: 0 15px 40px rgba(0,0,0,0.08);
}

.goal-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 40px;
}

.player-card { text-align: center; }

.player-headshot {
  width: 120px;
  height: 120px;
  border-radius: 16px;
  object-fit: cover;
  border: 3px solid var(--brand);
  margin-bottom: 12px;
}

.target-glow {
  box-shadow: 0 0 0 4px rgba(37,182,196,0.2);
}

.player-card strong { color: var(--brand); }

.top-centre {
  text-align: center;
  min-width: 180px;
}

.top-centre .label {
  font-size: 0.85rem;
  color: var(--muted);
}

.current-name {
  font-size: 1.2rem;
  font-weight: 700;
  color: var(--brand);
  margin-top: 4px;
}

.moves {
  margin-top: 12px;
  font-weight: 600;
  color: var(--brand);
}

.choices-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
  gap: 16px;
  margin-top: 40px;
}

.choice-card {
  padding: 0;
  background: transparent;
  border: none;
  cursor: pointer;
  text-align: center;
}

.choice-card img:hover {
  transform: scale(1.08);
  box-shadow: 0 0 12px rgba(37,182,196,0.5);
}

.path {
  display: flex;
  flex-wrap: wrap;
  gap: 14px;
  margin-top: 50px;
  justify-content: center;
}

.step {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 14px;
  border-radius: 999px;
  background: rgba(37,182,196,0.08);
  border: 1px solid var(--brand);
  font-size: 0.9rem;
}

.step img {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  object-fit: cover;
  border: 1px solid var(--brand);
}

button.primary {
  background: var(--brand);
  color: white;
  border: none;
  padding: 10px 18px;
  border-radius: 10px;
  font-weight: 700;
  cursor: pointer;
}

button.primary:hover {
  background: var(--brand-dark);
}

.modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.3);
  display: flex;
  justify-content: center;
  align-items: center;
}

.hidden { display: none; }

.modal-content {
  background: white;
  padding: 40px;
  border-radius: 16px;
  text-align: center;
  max-width: 400px;
  border: 2px solid var(--brand);
}
.separator {
  grid-column: 1 / -1;
  text-align: center;
  margin: 10px 0;
  font-weight: 600;
  color: var(--muted);
  letter-spacing: 1px;
}
.section-header {
  grid-column: 1 / -1;
  text-align: center;
  margin: 15px 0 5px;
  font-weight: 700;
  font-size: 0.9rem;
  color: var(--muted);
  letter-spacing: 1px;
  text-transform: uppercase;
}
#how-to-play {
  background: rgba(37,182,196,0.08);
  padding: 16px 20px;
  border-radius: 12px;
  margin-bottom: 24px;
  border-left: 4px solid var(--brand);
  position: relative;
  transition: all 0.3s ease;
}

#how-to-play.collapsed {
  max-height: 40px;
  overflow: hidden;
}
.howto-toggle {
  position: absolute;
  top: 12px;
  right: 12px;
  background: transparent;
  border: none;
  font-size: 1.4rem;
  cursor: pointer;
  color: var(--brand);
  transition: transform 0.2s ease;
}
.howto-toggle:active {
  transform: scale(0.9);
}
.fullscreen-btn {
  position: absolute;
  top: 18px;
  right: 18px;
  background: white;
  color: var(--brand);
  border: 2px solid var(--brand);
  border-radius: 10px;
  padding: 6px 10px;
  font-size: 0.9rem;
  font-weight: 700;
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  transition: all 0.2s ease;
  z-index: 10;
}

.fullscreen-btn:hover {
  background: var(--brand);
  color: white;
  transform: translateY(-2px);
}

/* FULLSCREEN MODE */
body.fullscreen .card {
  margin: 0;
  max-width: none;
  width: 100vw;
  height: 100vh;
  border-radius: 0;
  box-shadow: none;
}

body.fullscreen header,
body.fullscreen footer {
  display: none;
}

body.fullscreen {
  overflow: hidden;
}
</style>
</head>

<body>

<div data-include="../includes/header.html"></div>

<div class="card">
<button id="fullscreenBtn" class="fullscreen-btn" onclick="toggleFullscreen()">
  Fullscreen
</button>
  <div id="how-to-play">
    <button id="howto-toggle-btn" onclick="toggleHowToPlay()" class="howto-toggle">âˆ’</button>
    <h3 style="margin-top:0;color:var(--brand);">How to Play</h3>
    <p style="margin:8px 0;font-size:0.95rem;">Connect the <strong>Start</strong> player to the <strong>Target</strong> player by finding teammates or managers who they once shared a club with. Select a club from the start player's career, then pick a teammate or manager they worked with/under. Keep moving through teammates/managers until you reach the target player!</p>
  </div>

  <div class="goal-row">
    <div class="player-card">
      <img id="start-img" class="player-headshot">
      <div><strong>Start</strong></div>
      <div id="start-name"></div>
    </div>

    <div class="top-centre">
      <div class="label">Current Player:</div>
      <div class="current-name" id="current-player"></div>
      <div class="moves">Moves: <span id="move-count">0</span></div>
    </div>

    <div class="player-card">
      <img id="target-img" class="player-headshot target-glow">
      <div><strong>Target</strong></div>
      <div id="target-name"></div>
    </div>
  </div>

  <div id="choices" class="choices-grid"></div>
  <div id="path" class="path"></div>

  <div style="text-align:center;margin-top:40px;">
    <button class="primary" onclick="startNewGame()">New Puzzle</button>
  </div>

</div>

<div id="win-modal" class="modal hidden">
  <div class="modal-content">
    <h2>ðŸŽ‰ Connection Complete!</h2>
    <p id="win-text"></p>
    <button class="primary" onclick="startNewGame(); closeModal();">
      Play Again
    </button>
  </div>
</div>

<div data-include="../includes/footer.html"></div>

<script src="./data.js"></script>
<script src="../includes/include-html.js"></script>

<script>
let startPlayer, currentEntity, targetPlayer;
let path = [];
let selectionMode = "club";
let selectedContext = null;

/* =============================
   UTIL
============================= */
function overlaps(a, b) {
  return Math.max(a[0], b[0]) <= Math.min(a[1], b[1]);
}

function isManager(name) {
  return !!managers[name];
}

/* =============================
   CLUB CONTEXTS (PLAYER OR MANAGER)
============================= */
function getClubContexts(entity) {
  const contexts = [];

  if (!isManager(entity)) {
    for (const club in players[entity].career) {
      players[entity].career[club].forEach(([s,e]) => {
        contexts.push({ club, range:[s,e], seasons:`${s===e?s:s+"â€“"+e}` });
      });
    }
  } else {
    for (const club in managers[entity]) {
      managers[entity][club].forEach(([s,e]) => {
        contexts.push({ club, range:[s,e], seasons:`${s===e?s:s+"â€“"+e}` });
      });
    }
  }

  return contexts;
}

/* =============================
   PLAYERS IN CLUB PERIOD
============================= */
function getPlayersInClubPeriod(club, range) {
  const res = [];

  for (const p in players) {

    // Skip current entity only if it's a player
    if (!isManager(currentEntity) && p === currentEntity) continue;

    if (!players[p].career[club]) continue;

    for (const r of players[p].career[club]) {
      if (overlaps(r, range)) {
        res.push({ name: p, type: "player" });
        break;
      }
    }
  }

  return res;
}

function getManagersInClubPeriod(club, range) {
  const res = [];

  for (const m in managers) {

    // Prevent manager self-loop
    if (isManager(currentEntity) && m === currentEntity) continue;

    if (!managers[m][club]) continue;

    for (const r of managers[m][club]) {
      if (overlaps(r, range)) {
        res.push({ name: m, type: "manager" });
        break;
      }
    }
  }

  return res;
}

function toggleFullscreen() {
  const btn = document.getElementById("fullscreenBtn");

  if (!document.fullscreenElement) {
    document.documentElement.requestFullscreen();
    document.body.classList.add("fullscreen");
    btn.textContent = "Exit Fullscreen";
  } else {
    document.exitFullscreen();
    document.body.classList.remove("fullscreen");
    btn.textContent = "Fullscreen";
  }
}

/* =============================
   RENDER CHOICES
============================= */
function renderChoices(items, mode, append = false) {

  const container = document.getElementById("choices");

  // Only clear automatically for club mode
  if (!append && mode === "club") {
    container.innerHTML = "";
  }

  items.forEach(item => {
    const div = document.createElement("div");
    div.className = "choice-card";

    if (mode === "club") {
      div.innerHTML = `
        <img src="${clubToBadge(item.club)}"
             style="width:80px;height:80px;border-radius:50%;border:2px solid var(--brand);">
        <div style="font-weight:600;margin-top:6px;">${item.seasons}</div>
      `;
      div.onclick = () => {
        selectedContext = item;
        selectionMode = "entity";
        render();
      };
    }

    else if (mode === "entity") {

      if (item.type === "manager") {
        div.innerHTML = `
          <img src="${managerToImage(item.name)}"
               style="width:80px;height:80px;border-radius:50%;border:2px dashed var(--brand);">
          <div style="font-weight:600;margin-top:6px;font-size:0.85rem;">${item.name}</div>
        `;
      } else {
        div.innerHTML = `
          <img src="${nameToImage(item.name)}"
               style="width:80px;height:80px;border-radius:50%;border:2px solid var(--brand);">
          <div style="font-weight:600;margin-top:6px;">${item.name}</div>
        `;
      }

      div.onclick = () => {
        currentEntity = item.name;
        path.push(item.name);
        selectionMode = "club";
        selectedContext = null;
        render();
        checkWin();
      };
    }

    container.appendChild(div);
  });
}

function toggleHowToPlay() {
  const box = document.getElementById("how-to-play");
  const btn = document.getElementById("howto-toggle-btn");

  box.classList.toggle("collapsed");

  const collapsed = box.classList.contains("collapsed");

  // Save state
  localStorage.setItem("howToPlayCollapsed", collapsed);

  // Update icon
  btn.textContent = collapsed ? "+" : "âˆ’";
}

function addSectionHeader(text) {
  const header = document.createElement("div");
  header.className = "section-header";
  header.textContent = text;
  document.getElementById("choices").appendChild(header);
}

/* =============================
   MAIN RENDER
============================= */
function render() {
  document.getElementById("start-name").textContent = startPlayer;
  document.getElementById("target-name").textContent = targetPlayer;
  document.getElementById("current-player").textContent = currentEntity;
  document.getElementById("move-count").textContent = path.length - 1;

  document.getElementById("start-img").src = nameToImage(startPlayer);
  document.getElementById("target-img").src = nameToImage(targetPlayer);

  document.getElementById("path").innerHTML =
    path.map(p => `
      <div class="step">
        <img src="${isManager(p)?managerToImage(p):nameToImage(p)}">
        <span>${p}</span>
      </div>
    `).join("");

  if (selectionMode === "club") {
    renderChoices(getClubContexts(currentEntity), "club");
  }

else if (selectionMode === "entity") {

  const club = selectedContext.club;
  const range = selectedContext.range;

  const container = document.getElementById("choices");
  container.innerHTML = "";

  const playersList = getPlayersInClubPeriod(club, range);

  // If manager â†’ only players
  if (isManager(currentEntity)) {

    if (playersList.length > 0) {
      addSectionHeader("Teammates");
      renderChoices(playersList, "entity");
    }

    return;
  }

  const managersList = getManagersInClubPeriod(club, range);

  // Players Section
  if (playersList.length > 0) {
    addSectionHeader("Teammates");
    renderChoices(playersList, "entity");
  }

  // Managers Section
  if (managersList.length > 0) {
    addSectionHeader("Managers");
    renderChoices(managersList, "entity", true);
  }
}
}

/* =============================
   GAME START
============================= */
function startNewGame() {
  const names = Object.keys(players);

  while (true) {
    const s = names[Math.floor(Math.random()*names.length)];
    const t = names[Math.floor(Math.random()*names.length)];
    if (s !== t) {
      startPlayer = s;
      targetPlayer = t;
      currentEntity = s;
      path = [s];
      selectionMode = "club";
      selectedContext = null;
      render();
      break;
    }
  }

  closeModal();
}

/* =============================
   HELPERS
============================= */
function nameToImage(name) {
  const last = name.split(" ").pop().toLowerCase().replace(/[^a-z0-9]/g,'');
  return `../../games/player-images/${last}.png`;
}

function managerToImage(name) {
  return nameToImage(name);
}

function clubToBadge(club) {
  return `../../games/badges/${club.toLowerCase().replace(/\s+/g,'')}.png`;
}

function checkWin() {
  if (currentEntity === targetPlayer) {
    document.getElementById("win-modal").classList.remove("hidden");
  }
}

function closeModal() {
  document.getElementById("win-modal").classList.add("hidden");
}

window.addEventListener("load", () => {
  const collapsed = localStorage.getItem("howToPlayCollapsed") === "true";
  const box = document.getElementById("how-to-play");
  const btn = document.getElementById("howto-toggle-btn");

  if (collapsed) {
    box.classList.add("collapsed");
    btn.textContent = "+";
  } else {
    btn.textContent = "âˆ’";
  }
});

document.addEventListener("fullscreenchange", () => {
  const btn = document.getElementById("fullscreenBtn");

  if (!document.fullscreenElement) {
    document.body.classList.remove("fullscreen");
    btn.textContent = "Fullscreen";
  }
});

startNewGame();
</script>


</body>
</html>